<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CHUNITHM è­œé¢ä¿å­˜ãƒ„ãƒ¼ãƒ«</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Helvetica Neue", sans-serif; padding: 1em; background: #f2f2f2; }
    h1 { font-size: 1.8em; margin-bottom: 0.5em; }
    label { display: block; margin: 0.2em 0; }
    input, select { padding: 0.6em; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; width: 95%; }
    button { padding: 0.6em; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; }
    button { background-color: #3d3d3d; color: white; cursor: pointer; margin-top: 0.5em; }
    button:hover { background-color: #555555; }
    .version { font-size: 0.5em; margin-left: 0.3em; }
    .container { background: white; padding: 1.5em; border-radius: 12px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
    .section { margin-bottom: 1.5em; }
    .note { font-size: 0.9em; color: #555; margin: 0.5em 0; }
    #preview { margin-top: 1em; text-align: center; }
    #preview img { max-width: 100%; height: auto; }
    ul#suggestions { list-style: none; padding: 0; margin-top: 0.5em; }
    ul#suggestions li { display: flex; align-items: center; padding: 0.5em; background: #eee; margin-bottom: 0.3em; cursor: pointer; border-radius: 5px; font-size: 0.95em; }
    ul#suggestions li:hover { background: #ddd; }
    .diff-label { min-width: 3em; margin-right: 1.5em; font-weight: bold; color: white; padding: 0.2em 0.5em; border-radius: 4px; text-align: center; }
    .level-label { min-width: 3em; font-weight: bold; text-align: left; color: #333; }
    .song-title { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>CHUNITHM è­œé¢æ¤œç´¢/DLãƒ„ãƒ¼ãƒ« <span class="version">v1.0.0</span></h1>

    <div class="section">
      <div class="note">
        è­œé¢ç”»åƒã¯
        <a href="https://sdvx.in/chunithm.html" target="_blank">CHUNITHMè­œé¢ä¿ç®¡æ‰€</a>
        ã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™ã€‚
      </div>
    </div>

    <div class="section">
      <label>æ›²åæ¤œç´¢:</label>
      <input type="text" id="search" placeholder="å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™...">
      <ul id="suggestions" style="display: none;"></ul>
    </div>

    <div class="section">
      <label>è­œé¢URLã‚’ç›´æ¥å…¥åŠ›ã™ã‚‹å ´åˆ:</label>
      <input type="text" id="url" placeholder="https://sdvx.in/chunithm/10/10098mst.htm">
    </div>

    <div class="section">
      <button onclick="fetchAndSaveChart()">ğŸ“¥ è­œé¢ã‚’ä¿å­˜</button>
    </div>

    <div class="note">
      ãƒ»ã‚¹ãƒšãƒ¼ã‚¹æœ‰ç„¡ã‚’ç„¡è¦–ã—ãŸæ¤œç´¢ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚<br>
      ãƒ»ä¸€éƒ¨ä¿å­˜ã§ããªã„è­œé¢ãŒã‚ã‚Šã¾ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚
    </div>

    <div id="preview"></div>
  </div>

  <script>
    const songList = [];
    async function loadSongList() {
      try {
        const res = await fetch('./chunithm_songs.json');
        const data = await res.json();
        songList.push(...data);
      } catch (err) {
        alert("è­œé¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        console.error(err);
      }
    }

  document.getElementById('search').addEventListener('input', function () {
    const searchField = document.getElementById('search');
    const urlField = document.getElementById('url');
    const input = searchField.value.replace(/\s/g, '').toLowerCase();
    const suggestions = document.getElementById('suggestions');

    // å€™è£œã‚¯ãƒªã‚¢
    suggestions.innerHTML = '';

    if (input === "") {
      // ä¸¡æ–¹ã®è‰²ã‚’ã‚¯ãƒªã‚¢
      searchField.style.backgroundColor = '';
      urlField.style.backgroundColor = '';

      // URLæ¬„ã®å†…å®¹ã‚‚ã‚¯ãƒªã‚¢
      urlField.value = '';

      suggestions.style.display = 'none';
      return;
    }

    const results = songList
      .filter(song => song.name.replace(/\s/g, '').toLowerCase().includes(input))
      .sort((a, b) => {
        const aName = a.name.replace(/\s/g, '').toLowerCase();
        const bName = b.name.replace(/\s/g, '').toLowerCase();
        return (aName.startsWith(input) ? -1 : 1) - (bName.startsWith(input) ? -1 : 1);
      });

    if (results.length === 0) {
      suggestions.style.display = 'none';
      return;
    }

    results.slice(0, 10).forEach(song => {
      const li = document.createElement('li');

      const originalName = song.name;
      const normalized = originalName.replace(/\s/g, '').toLowerCase();
      const matchIndex = normalized.indexOf(input);

      let displayName = originalName;

      if (matchIndex !== -1) {
        // å…ƒã®æ›²åã®ä¸­ã§ä¸€è‡´éƒ¨åˆ†ã‚’å¤ªå­—ã«ã™ã‚‹
        let flatIndex = 0;
        let matchStart = -1;
        let matchEnd = -1;

        // ç©ºç™½ã‚’ç„¡è¦–ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰ã€å…ƒã®æ–‡å­—åˆ—ä¸­ã®ç¯„å›²ã‚’ç‰¹å®š
        for (let i = 0; i < originalName.length; i++) {
          if (originalName[i] === ' ') continue;
          if (flatIndex === matchIndex) matchStart = i;
          if (flatIndex === matchIndex + input.length - 1) {
            matchEnd = i;
            break;
          }
          flatIndex++;
        }

        if (matchStart !== -1 && matchEnd !== -1) {
          displayName =
            originalName.slice(0, matchStart) +
            '<strong>' +
            originalName.slice(matchStart, matchEnd + 1) +
            '</strong>' +
            originalName.slice(matchEnd + 1);
        }
      }

      const diffColor = {
        MAS: "#a0a",
        ULT: "#862333",
        WE:  "#273eba"
      }[song.diff] || "#333";

      li.innerHTML = `
        <span class="diff-label" style="background:${diffColor}">${song.diff}</span>
        <span class="level-label">${song.level || '?'}</span>
        <span class="song-title">${displayName}</span>
      `;

      li.onclick = () => {
        document.getElementById('url').value = song.url;
        document.getElementById('search').value = song.name;
        suggestions.innerHTML = '';
        suggestions.style.display = 'none';
        highlightField('search');
        highlightField('url');
      };

      suggestions.appendChild(li);
    });

    suggestions.style.display = results.length ? 'block' : 'none';
  });

  document.getElementById('url').addEventListener('input', function () {
    clearHighlightIfEmpty('url');
  });

  async function fetchAndSaveChart() {
    const url = document.getElementById('url').value.trim();
    if (!url.startsWith('http')) return alert('æ­£ã—ã„è­œé¢URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    const match = url.match(/\/(\d{5})([a-zA-Z0-9]+)\.htm$/);
    if (!match) return alert('è­œé¢URLã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');

    const song_id = match[1];
    const diffcode = match[2];
    const imagePath = `resized_charts/${song_id}${diffcode}.png`;

    // æ›²åã‚’æ¤œç´¢
    const song = songList.find(s => s.url === url);
    const title = song ? song.name : `${song_id}${diffcode}`;

    try {
      const img = await loadImage(imagePath);

      const newTab = window.open();
      if (!newTab) {
        alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const imgURL = img.src;

      newTab.document.write(`
        <html>
          <head>
            <title>${title}</title>
            <style>
              body {
                margin: 0;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
              }
              img {
                max-width: 100%;
                height: auto;
                box-shadow: 0 0 20px rgba(255,255,255,0.2);
              }
            </style>
          </head>
          <body>
            <img src="${imgURL}" alt="${title}">
          </body>
        </html>
      `);
      newTab.document.close();
    } catch (e) {
      alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è­œé¢ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
      console.error(e);
    }
  }

  function loadImage(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error(`ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: ${src}`));
      img.src = src;
    });
  }

  function highlightField(id) {
    const el = document.getElementById(id);
    el.style.backgroundColor = '#fff9c4';
  }

  function clearHighlightIfEmpty(id) {
    const el = document.getElementById(id);
    if (el.value.trim() === "") {
      el.style.backgroundColor = '';
    }
  }

  loadSongList();
  </script>
</body>
</html>
