<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CHUNITHM è­œé¢ä¿å­˜ãƒ„ãƒ¼ãƒ«</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Helvetica Neue", sans-serif; padding: 1em; background: #f2f2f2; }
    h1 { font-size: 1.8em; margin-bottom: 0.5em; }
    label { display: block; margin: 0.2em 0; }
    .inline-label { display: inline-block; margin-right: 0.8em; font-size: 0.9em; }
    input[type="text"] { padding: 0.6em; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; width: 95%; }
    input[type="checkbox"] { padding: 0.4em; border: 1px solid #ccc; border-radius: 5px; }
    button { padding: 0.6em; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; background-color: #3d3d3d; color: white; cursor: pointer; margin-top: 0.5em; }
    button.save { margin-right: 0.5em; }
    button:hover { background-color: #555555; }
    .version { font-size: 0.5em; margin-left: 0.3em; }
    .container { background: white; padding: 1.5em; border-radius: 12px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
    .section { margin-bottom: 1.5em; }
    .note { font-size: 0.9em; color: #555; margin: 0.5em 0; }
    #preview { margin-top: 1em; text-align: center; }
    #preview img { max-width: 100%; height: auto; }
    ul#suggestions { list-style: none; padding: 0; margin-top: 0.5em; }
    ul#suggestions li { display: flex; align-items: center; padding: 0.5em; background: #eee; margin-bottom: 0.3em; cursor: pointer; border-radius: 5px; font-size: 0.95em; }
    ul#suggestions li:hover { background: #ddd; }
    .suggestion-item { display: flex; align-items: center; padding: 0.5em; background: #eee; margin-bottom: 0.3em; cursor: pointer; border-radius: 5px; font-size: 0.95em; }
    .suggestion-item:hover { background: #ddd; }
    .diff-label { min-width: 2.2em; margin-right: 0.5em; font-weight: bold; color: white; padding: 0.2em 0.5em; border-radius: 4px; text-align: center; }
    .level-label { min-width: 1.8em; margin-right: 0.5em; font-weight: bold; text-align: left; color: #333; }
    .song-title { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    @media screen and (max-width: 500px) {
      .inline-label { font-size: 0.8em; }
      input[type="text"], input[type="checkbox"] { font-size: 0.8em; }
      button { font-size: 0.9em; }
      .diff-label { font-size: 0.7em; }
      .level-label { font-size: 0.75em; }
      .song-title { font-size: 0.85em; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>CHUNITHM è­œé¢æ¤œç´¢/DLãƒ„ãƒ¼ãƒ« <span class="version">v1.1.11</span></h1>

    <div class="section">
      <div class="note">
        è­œé¢ç”»åƒã¯
        <a href="https://sdvx.in/chunithm.html" target="_blank">CHUNITHMè­œé¢ä¿ç®¡æ‰€</a>
        ã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™ã€‚
      </div>
    </div>

    <div class="section">
      <label>è­œé¢ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
      <label class="inline-label"><input type="checkbox" id="filterMAS"> MAS</label>
      <label class="inline-label"><input type="checkbox" id="filterULT"> ULT</label>
      <label class="inline-label"><input type="checkbox" id="filterWE"> WE</label>
    </div>
  
    <div class="section">
      <label>æ›²åæ¤œç´¢:</label>
      <input type="text" id="search" placeholder="å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™...">
      <ul id="suggestions" style="display: none;"></ul>
    </div>

    <div class="section">
      <label>è­œé¢URLã‚’ç›´æ¥å…¥åŠ›ã™ã‚‹å ´åˆ:</label>
      <input type="text" id="url" placeholder="https://sdvx.in/chunithm/10/10098mst.htm">
    </div>

    <div class="section">
      <details id="recentSongs" style="margin: 1em 0;">
        <summary style="cursor:pointer; font-weight:bold;">
          æœ€è¿‘è¿½åŠ ã•ã‚ŒãŸè­œé¢:
        </summary>
        <ul id="recentList" style="list-style:none; padding:0; margin-top:0.5em;"></ul>
      </details>

      <button class="save" onclick="fetchAndSaveChart()">ğŸ“¥ è­œé¢ã‚’è¦‹ã‚‹</button>
      <button id="resetBtn">å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="note">
      ãƒ»2025/11/30æ™‚ç‚¹ã§ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è­œé¢ã«å¯¾å¿œã—ã¾ã—ãŸã€‚<br>
      ãƒ»ã‚¹ãƒšãƒ¼ã‚¹æœ‰ç„¡ã‚’ç„¡è¦–ã—ãŸæ¤œç´¢ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚<br>
      ãƒ»ä¸€éƒ¨ä¿å­˜ã§ããªã„è­œé¢ãŒã‚ã‚Šã¾ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚
    </div>

    <div id="preview"></div>
  </div>

  <script>
    const songList = [];
    async function loadSongList() {
      try {
        const res = await fetch('./prev_chunithm_songs.json');
        const data = await res.json();
        songList.push(...data);
      } catch (err) {
        alert("è­œé¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        console.error(err);
      }
    }

    function loadPrefs() {
      ['MAS','ULT','WE'].forEach(diff => {
        const cb = document.getElementById('filter'+diff);
        const stored = localStorage.getItem('filter'+diff);
        cb.checked = stored === null ? true : stored === 'true';
        cb.addEventListener('change', () => {
          localStorage.setItem('filter'+diff, cb.checked);
          document.getElementById('search').dispatchEvent(new Event('input')); // ãƒã‚§ãƒƒã‚¯å¤‰æ›´æ™‚å†æ¤œç´¢
        });
      });
    }

    document.getElementById('search').addEventListener('input', function () {
      const searchField = document.getElementById('search');
      const urlField = document.getElementById('url');
      const input = searchField.value.replace(/\s/g, '').toLowerCase();
      const suggestions = document.getElementById('suggestions');

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹å–å¾—
      const masEnabled = document.getElementById('filterMAS').checked;
      const ultEnabled = document.getElementById('filterULT').checked;
      const weEnabled  = document.getElementById('filterWE').checked;

      // å€™è£œã‚¯ãƒªã‚¢
      suggestions.innerHTML = '';

      if (input === "") {
        // ä¸¡æ–¹ã®è‰²ã‚’ã‚¯ãƒªã‚¢
        searchField.style.backgroundColor = '';
        urlField.style.backgroundColor = '';

        // URLæ¬„ã®å†…å®¹ã‚‚ã‚¯ãƒªã‚¢
        urlField.value = '';

        suggestions.style.display = 'none';
        return;
      }
      const results = songList
        .filter(song => {
          const nameNorm = song.name.replace(/\s/g, '').toLowerCase();
          if (!nameNorm.includes(input)) return false;
          // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
          if (song.diff === 'MAS' && !masEnabled) return false;
          if (song.diff === 'ULT' && !ultEnabled) return false;
          if (song.diff === 'WE'  && !weEnabled) return false;
          return true;
        })
        .sort((a, b) => {
          const aName = a.name.replace(/\s/g, '').toLowerCase();
          const bName = b.name.replace(/\s/g, '').toLowerCase();
          return (aName.startsWith(input) ? -1 : 1) - (bName.startsWith(input) ? -1 : 1);
        });

      if (results.length === 0) {
        suggestions.style.display = 'none';
        return;
      }

      results.slice(0, 99).forEach(song => {
        const li = document.createElement('li');

        const originalName = song.name;
        const normalized = originalName.replace(/\s/g, '').toLowerCase();
        const matchIndex = normalized.indexOf(input);

        let displayName = originalName;

        if (matchIndex !== -1) {
          // å…ƒã®æ›²åã®ä¸­ã§ä¸€è‡´éƒ¨åˆ†ã‚’å¤ªå­—ã«ã™ã‚‹
          let flatIndex = 0;
          let matchStart = -1;
          let matchEnd = -1;

          // ç©ºç™½ã‚’ç„¡è¦–ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰ã€å…ƒã®æ–‡å­—åˆ—ä¸­ã®ç¯„å›²ã‚’ç‰¹å®š
          for (let i = 0; i < originalName.length; i++) {
            if (originalName[i] === ' ') continue;
            if (flatIndex === matchIndex) matchStart = i;
            if (flatIndex === matchIndex + input.length - 1) {
              matchEnd = i;
              break;
            }
            flatIndex++;
          }

          if (matchStart !== -1 && matchEnd !== -1) {
            displayName =
              originalName.slice(0, matchStart) +
              '<strong>' +
              originalName.slice(matchStart, matchEnd + 1) +
              '</strong>' +
              originalName.slice(matchEnd + 1);
          }
        }

        const diffColor = {
          MAS: "#a0a",
          ULT: "#862333",
          WE:  "#273eba"
        }[song.diff] || "#333";

        li.innerHTML = `
          <span class="diff-label" style="background:${diffColor}">${song.diff}</span>
          <span class="level-label">${song.level || '?'}</span>
          <span class="song-title">${displayName}</span>
        `;

        li.onclick = () => {
          document.getElementById('url').value = song.url;
          document.getElementById('search').value = song.name;
          suggestions.innerHTML = '';
          suggestions.style.display = 'none';
          highlightField('search');
          highlightField('url');
        };

        suggestions.appendChild(li);
      });

      suggestions.style.display = 'block';
    });

    document.getElementById('url').addEventListener('input', function () {
      clearHighlightIfEmpty('url');
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('search').value = '';
      document.getElementById('url').value = '';
      ['search','url'].forEach(id => document.getElementById(id).style.backgroundColor = '');
    });

    async function fetchAndSaveChart() {
      const url = document.getElementById('url').value.trim();
      if (!url.startsWith('http')) return alert('æ­£ã—ã„è­œé¢URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

      const match = url.match(/\/(\d{5})([a-zA-Z0-9]+)\.htm$/);
      if (!match) return alert('è­œé¢URLã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');

      const song_id = match[1];
      const diffcode = match[2];
      const imagePath = `resized_charts/${song_id}${diffcode}.png`;

      // æ›²åã‚’æ¤œç´¢
      const song = songList.find(s => s.url === url);
      const title = song ? song.name : `${song_id}${diffcode}`;

      const newTab = window.open();
      if (!newTab) {
        alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // èª­ã¿è¾¼ã¿ä¸­ã®è¡¨ç¤º
      newTab.document.write(`
        <html>
          <head>
            <title>${title}</title>
            <style>
              body {
                margin: 0;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                color: white;
                font-family: sans-serif;
                font-size: 0.5em;
              }
            </style>
          </head>
          <body>
            èª­ã¿è¾¼ã¿ä¸­...
          </body>
        </html>
      `);
      newTab.document.close();


      try {
        const img = await loadImage(imagePath);
        const imgURL = img.src;

        newTab.document.body.innerHTML = `
          <img src="${imgURL}" alt="${title}" style="
            max-width: 100%;
            height: auto;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
          ">`;
      } catch (e) {
        newTab.document.body.innerHTML = ('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è­œé¢ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
        console.error(e);
      }
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error(`ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: ${src}`));
        img.src = src;
      });
    }

    function highlightField(id) {
      const el = document.getElementById(id);
      el.style.backgroundColor = '#fff9c4';
    }

    function clearHighlightIfEmpty(id) {
      const el = document.getElementById(id);
      if (el.value.trim() === "") {
        el.style.backgroundColor = '';
      }
    }

    // diff_log.txt ã‚’èª­ã¿è¾¼ã‚“ã§ã€æœ€è¿‘ã®æ›²ä¸€è¦§ã‚’è¡¨ç¤º
    async function loadRecentSongs() {
      try {
        const res    = await fetch('./diff_songs.json');
        const recent = await res.json();
        const ul     = document.getElementById('recentList');
        ul.innerHTML = '';

        recent.forEach(item => {
          const li = document.createElement('li');
          // æ—¢å­˜ã®ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã¨åŒã˜ã‚¯ãƒ©ã‚¹åãŒã‚ã‚Œã°æŒ‡å®š
          li.classList.add('suggestion-item');
          li.innerHTML = `
            <span class="diff-label" style="background:${getColor(item.diff)}">
              ${item.diff}
            </span>
            <span class="level-label">${item.level || '?'}</span>
            <span class="song-title">${item.name}</span>
          `;
          li.style.padding = '0.5em';
          li.style.cursor  = 'pointer';
          li.addEventListener('click', () => {
            document.getElementById('search').value = item.name;
            document.getElementById('url').value    = item.url;
            highlightField('search');
            highlightField('url');
          });
          ul.appendChild(li);
        });
      } catch (err) {
        console.error('diff_songs.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', err);
      }
    }

    function getColor(diff) {
      return {
        MAS: "#a0a",
        ULT: "#862333",
        WE:  "#273eba"
      }[diff] || "#333";
    }

    // åˆæœŸåŒ–
    loadSongList();
    loadPrefs();
    loadRecentSongs();
  </script>
</body>
</html>
